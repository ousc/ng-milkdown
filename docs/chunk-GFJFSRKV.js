import{Na as b,Ra as N,a as C,b as w,o as k,q as c,s as v,t as y,ua as O,w as m,y as T,z as V}from "./chunk-WBJK5ZQV.js";import"./chunk-ILE44FN6.js";import{a as S}from "./chunk-GAL4ENT6.js";function R(o={}){return new m({view(e){return new x(e,o)}})}var x=class{constructor(e, t){var i;this.editorView=e,this.cursorPos=null,this.element=null,this.timeout=-1,this.width=(i=t.width)!==null&&i!==void 0?i:1,this.color=t.color===!1?void 0:t.color||"black",this.class=t.class,this.handlers=["dragover","dragend","drop","dragleave"].map(r=>{let l= n=>{this[r](n)};return e.dom.addEventListener(r,l),{name:r,handler:l}})}destroy(){this.handlers.forEach(({name:e,handler:t})=>this.editorView.dom.removeEventListener(e,t))}update(e, t){this.cursorPos!=null&&t.doc!=e.state.doc&&(this.cursorPos>e.state.doc.content.size?this.setCursor(null):this.updateOverlay())}setCursor(e){e!=this.cursorPos&&(this.cursorPos=e,e==null?(this.element.parentNode.removeChild(this.element),this.element=null):this.updateOverlay())}updateOverlay(){let e=this.editorView.state.doc.resolve(this.cursorPos),t=!e.parent.inlineContent,i;if(t){let s=e.nodeBefore,a=e.nodeAfter;if(s||a){let u=this.editorView.nodeDOM(this.cursorPos-(s?s.nodeSize:0));if(u){let p=u.getBoundingClientRect(),h=s?p.bottom:p.top;s&&a&&(h=(h+this.editorView.nodeDOM(this.cursorPos).getBoundingClientRect().top)/2),i={left:p.left,right:p.right,top:h-this.width/2,bottom:h+this.width/2}}}}if(!i){let s=this.editorView.coordsAtPos(this.cursorPos);i={left:s.left-this.width/2,right:s.left+this.width/2,top:s.top,bottom:s.bottom}}let r=this.editorView.dom.offsetParent;this.element||(this.element=r.appendChild(document.createElement("div")),this.class&&(this.element.className=this.class),this.element.style.cssText="position: absolute; z-index: 50; pointer-events: none;",this.color&&(this.element.style.backgroundColor=this.color)),this.element.classList.toggle("prosemirror-dropcursor-block",t),this.element.classList.toggle("prosemirror-dropcursor-inline",!t);let l,n;if(!r||r==document.body&&getComputedStyle(r).position=="static")l=-pageXOffset,n=-pageYOffset;else{let s=r.getBoundingClientRect();l=s.left-r.scrollLeft,n=s.top-r.scrollTop}this.element.style.left=i.left-l+"px",this.element.style.top=i.top-n+"px",this.element.style.width=i.right-i.left+"px",this.element.style.height=i.bottom-i.top+"px"}scheduleRemoval(e){clearTimeout(this.timeout),this.timeout=setTimeout(()=>this.setCursor(null),e)}dragover(e){if(!this.editorView.editable)return;let t=this.editorView.posAtCoords({left:e.clientX,top:e.clientY}),i=t&&t.inside>=0&&this.editorView.state.doc.nodeAt(t.inside),r=i&&i.type.spec.disableDropCursor,l=typeof r=="function"?r(this.editorView,t,e):r;if(t&&!l){let n=t.pos;if(this.editorView.dragging&&this.editorView.dragging.slice){let s=k(this.editorView.state.doc,n,this.editorView.dragging.slice);s!=null&&(n=s)}this.setCursor(n),this.scheduleRemoval(5e3)}}dragend(){this.scheduleRemoval(20)}drop(){this.scheduleRemoval(20)}dragleave(e){(e.target==this.editorView.dom||!this.editorView.dom.contains(e.relatedTarget))&&this.setCursor(null)}};var d=class o extends c{constructor(e){super(e,e)}map(e, t){let i=e.resolve(t.map(this.head));return o.valid(i)?new o(i):c.near(i)}content(){return w.empty}eq(e){return e instanceof o&&e.head==this.head}toJSON(){return{type:"gapcursor",pos:this.head}}static fromJSON(e, t){if(typeof t.pos!="number")throw new RangeError("Invalid input for GapCursor.fromJSON");return new o(e.resolve(t.pos))}getBookmark(){return new A(this.anchor)}static valid(e){let t=e.parent;if(t.isTextblock||!L(e)||!z(e))return!1;let i=t.type.spec.allowGapCursor;if(i!=null)return i;let r=t.contentMatchAt(e.index()).defaultType;return r&&r.isTextblock}static findGapCursorFrom(e, t, i=!1){e:for(;;){if(!i&&o.valid(e))return e;let r=e.pos,l=null;for(let n=e.depth;; n--){let s=e.node(n);if(t>0?e.indexAfter(n)<s.childCount:e.index(n)>0){l=s.child(t>0?e.indexAfter(n):e.index(n)-1);break}else if(n==0)return null;r+=t;let a=e.doc.resolve(r);if(o.valid(a))return a}for(;;){let n=t>0?l.firstChild:l.lastChild;if(!n){if(l.isAtom&&!l.isText&&!y.isSelectable(l)){e=e.doc.resolve(r+l.nodeSize*t),i=!1;continue e}break}l=n,r+=t;let s=e.doc.resolve(r);if(o.valid(s))return s}return null}}};d.prototype.visible=!1;d.findFrom=d.findGapCursorFrom;c.jsonID("gapcursor",d);var A=class o{constructor(e){this.pos=e}map(e){return new o(e.map(this.pos))}resolve(e){let t=e.resolve(this.pos);return d.valid(t)?new d(t):c.near(t)}};function L(o){for(let e=o.depth; e>=0; e--){let t=o.index(e),i=o.node(e);if(t==0){if(i.type.spec.isolating)return!0;continue}for(let r=i.child(t-1);; r=r.lastChild){if(r.childCount==0&&!r.inlineContent||r.isAtom||r.type.spec.isolating)return!0;if(r.inlineContent)return!1}}return!0}function z(o){for(let e=o.depth; e>=0; e--){let t=o.indexAfter(e),i=o.node(e);if(t==i.childCount){if(i.type.spec.isolating)return!0;continue}for(let r=i.child(t);; r=r.firstChild){if(r.childCount==0&&!r.inlineContent||r.isAtom||r.type.spec.isolating)return!0;if(r.inlineContent)return!1}}return!0}function D(){return new m({props:{decorations:X,createSelectionBetween(o, e, t){return e.pos==t.pos&&d.valid(t)?new d(t):null},handleClick:G,handleKeyDown:M,handleDOMEvents:{beforeinput:J}}})}var M=O({ArrowLeft:g("horiz",-1),ArrowRight:g("horiz",1),ArrowUp:g("vert",-1),ArrowDown:g("vert",1)});function g(o, e){let t=o=="vert"?e>0?"down":"up":e>0?"right":"left";return function(i, r, l){let n=i.selection,s=e>0?n.$to:n.$from,a=n.empty;if(n instanceof v){if(!l.endOfTextblock(t)||s.depth==0)return!1;a=!1,s=i.doc.resolve(e>0?s.after():s.before())}let u=d.findGapCursorFrom(s,e,a);return u?(r&&r(i.tr.setSelection(new d(u))),!0):!1}}function G(o, e, t){if(!o||!o.editable)return!1;let i=o.state.doc.resolve(e);if(!d.valid(i))return!1;let r=o.posAtCoords({left:t.clientX,top:t.clientY});return r&&r.inside>-1&&y.isSelectable(o.state.doc.nodeAt(r.inside))?!1:(o.dispatch(o.state.tr.setSelection(new d(i))),!0)}function J(o, e){if(e.inputType!="insertCompositionText"||!(o.state.selection instanceof d))return!1;let{$from:t}=o.state.selection,i=t.parent.contentMatchAt(t.index()).findWrapping(o.state.schema.nodes.text);if(!i)return!1;let r=C.empty;for(let n=i.length-1; n>=0; n--)r=C.from(i[n].createAndFill(null,r));let l=o.state.tr.replace(t.pos,t.pos,new w(r,0,0));return l.setSelection(v.near(l.doc.resolve(t.pos+1))),o.dispatch(l),!1}function X(o){if(!(o.selection instanceof d))return null;let e=document.createElement("div");return e.className="ProseMirror-gapcursor",V.create(o.doc,[T.widget(o.selection.head,e,{key:"gapcursor"})])}function P(o, e){return Object.assign(o,{meta:S({package:"@milkdown/plugin-cursor"},e)}),o}var f=N({},"dropCursorConfig");P(f,{displayName:"Ctx<dropCursor>"});var B=b(o=>R(o.get(f.key)));P(B,{displayName:"Prose<dropCursor>"});var E=b(()=>D());P(E,{displayName:"Prose<gapCursor>"});var F=[f,B,E];var re=(o, e)=>{o.config(t=>{t.update(f.key,()=>{var i,r;return{class:"crepe-drop-cursor",width:(i=e?.width)!=null?i:4,color:(r=e?.color)!=null?r:!1}})}).use(F)};export{re as defineFeature};
