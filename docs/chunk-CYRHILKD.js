import{a as Ct}from "./chunk-6ZGCKHA5.js";import{a as ht,c as ct,d as dt}from "./chunk-OJSX3Q5S.js";import{Na as rt,Ra as q,da as B,f as at,ja as ot,t as X,va as K,w as nt,x as lt}from "./chunk-WBJK5ZQV.js";import{a as T,b as V,f as yt}from "./chunk-GAL4ENT6.js";var kt=yt(Ct(),1);var ft= s=>{throw TypeError(s)},Z=(s, t, e)=>t.has(s)||ft("Cannot "+e),i=(s, t, e)=>(Z(s,t,"read from private field"),e?e.call(s):t.get(s)),r=(s, t, e)=>t.has(s)?ft("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(s):t.set(s,e),n=(s, t, e, l)=>(Z(s,t,"write to private field"),l?l.call(s,e):t.set(s,e),e),Mt=(s, t, e)=>(Z(s,t,"access private method"),e);function U(s, t){return Object.assign(s,{meta:T({package:"@milkdown/plugin-block"},t)}),s}var Wt= s=>!ot(t=>t.type.name==="table")(s),H=q({filterNodes:Wt},"blockConfig");U(H,{displayName:"Ctx<blockConfig>"});function xt(s, t, e){var l;if(!s.dom.parentElement)return null;try{let a=(l=s.posAtCoords({left:t.x,top:t.y}))==null?void 0:l.inside;if(a==null||a<0)return null;let o=s.state.doc.resolve(a),c=s.state.doc.nodeAt(a),d=s.nodeDOM(a),h= x=>{let E=o.depth>=1&&o.index(o.depth)===0;if(!(x||E))return;let S=o.before(o.depth);c=s.state.doc.nodeAt(S),d=s.nodeDOM(S),o=s.state.doc.resolve(S),e(o,c)||h(!0)},p=e(o,c);return h(!p),!d||!c?null:{node:c,$pos:o,el:d}}catch{return null}}var pt=null;function Et(){return pt||(pt=document.implementation.createHTMLDocument("title"))}var St={thead:["table"],tbody:["table"],tfoot:["table"],caption:["table"],colgroup:["table"],col:["table","colgroup"],tr:["table","tbody"],td:["table","tbody","tr"],th:["table","tbody","tr"]};function Tt(s, t){let e=[],{openStart:l,openEnd:a,content:o}=t;for(; l>1&&a>1&&o.childCount===1&&o.firstChild.childCount===1;){l-=1,a-=1;let m=o.firstChild;e.push(m.type.name,m.attrs!==m.type.defaultAttrs?m.attrs:null),o=m.content}let c=s.someProp("clipboardSerializer")||at.fromSchema(s.state.schema),d=Et(),h=d.createElement("div");h.appendChild(c.serializeFragment(o,{document:d}));let p=h.firstChild,x,E=0;for(; p&&p.nodeType===1&&(x=St[p.nodeName.toLowerCase()]);){for(let m=x.length-1; m>=0; m--){let st=d.createElement(x[m]);for(; h.firstChild;)st.appendChild(h.firstChild);h.appendChild(st),E++}p=h.firstChild}p&&p.nodeType===1&&p.setAttribute("data-pm-slice",`${l} ${a}${E?` -${E}`:""} ${JSON.stringify(e)}`);let S=s.someProp("clipboardTextSerializer", m=>m(t,s))||t.content.textBetween(0,t.content.size,`

`);return{dom:h,text:S}}var ut=B.ie&&B.ie_version<15||B.ios&&B.webkit_version<604,mt=20,F,I,b,g,D,f,v,vt,P,w,y,Y,L,O,$,_,C,G=class{constructor(){r(this,v),r(this,F),r(this,I),r(this,b),r(this,g),r(this,D),r(this,f),r(this,w),r(this,y),r(this,Y),r(this,L),r(this,O),r(this,$),r(this,_),r(this,C),n(this,I,()=>{if(!i(this,g))return null;let t=i(this,g),e=i(this,v,P);if(e&&X.isSelectable(t.node)){let l=X.create(e.state.doc,t.$pos.pos);return e.dispatch(e.state.tr.setSelection(l)),e.focus(),n(this,b,l),l}return null}),n(this,b,null),n(this,g,null),n(this,D,void 0),n(this,f,!1),n(this,y,()=>{var t;(t=i(this,w))==null||t.call(this,{type:"hide"}),n(this,g,null)}),n(this,Y,t=>{var e;n(this,g,t),(e=i(this,w))==null||e.call(this,{type:"show",active:t})}),this.bind=(t,e)=>{n(this,F,t),n(this,w,e)},this.addEvent=t=>{t.addEventListener("mousedown",i(this,L)),t.addEventListener("mouseup",i(this,O)),t.addEventListener("dragstart",i(this,$))},this.removeEvent=t=>{t.removeEventListener("mousedown",i(this,L)),t.removeEventListener("mouseup",i(this,O)),t.removeEventListener("dragstart",i(this,$))},this.unBind=()=>{n(this,w,void 0)},n(this,L,()=>{var t;n(this,D,(t=i(this,g))==null?void 0:t.el.getBoundingClientRect()),i(this,I).call(this)}),n(this,O,()=>{if(!i(this,f)){requestAnimationFrame(()=>{var t;i(this,D)&&((t=i(this,v,P))==null||t.focus())});return}n(this,f,!1),n(this,b,null)}),n(this,$,t=>{var e;n(this,f,!0);let l=i(this,v,P);if(!l)return;l.dom.dataset.dragging="true";let a=i(this,b);if(t.dataTransfer&&a){let o=a.content();t.dataTransfer.effectAllowed="copyMove";let{dom:c,text:d}=Tt(l,o);t.dataTransfer.clearData(),t.dataTransfer.setData(ut?"Text":"text/html",c.innerHTML),ut||t.dataTransfer.setData("text/plain",d);let h=(e=i(this,g))==null?void 0:e.el;h&&t.dataTransfer.setDragImage(h,0,0),l.dragging={slice:o,move:!0}}}),this.keydownCallback=t=>(i(this,y).call(this),n(this,f,!1),t.dom.dataset.dragging="false",!1),n(this,_,(0,kt.default)((t,e)=>{if(!t.editable)return;let l=t.dom.getBoundingClientRect(),a=l.left+l.width/2;if(!(t.root.elementFromPoint(a,e.clientY)instanceof Element)){i(this,y).call(this);return}let o=i(this,v,vt);if(!o)return;let c=xt(t,{x:a,y:e.clientY},o);if(!c){i(this,y).call(this);return}i(this,Y).call(this,c)},200)),this.mousemoveCallback=(t,e)=>(t.composing||!t.editable||i(this,_).call(this,t,e),!1),this.dragoverCallback=(t,e)=>{var l;if(i(this,f)){let a=(l=i(this,v,P))==null?void 0:l.dom.parentElement;if(!a)return!1;let o=a.scrollHeight>a.clientHeight,c=a.getBoundingClientRect();if(o){if(a.scrollTop>0&&Math.abs(e.y-c.y)<mt){let h=a.scrollTop>10?a.scrollTop-10:0;return a.scrollTop=h,!1}let d=Math.round(t.dom.getBoundingClientRect().height);if(Math.round(a.scrollTop+c.height)<d&&Math.abs(e.y-(c.height+c.y))<mt){let h=a.scrollTop+10;return a.scrollTop=h,!1}}}return!1},this.dragenterCallback=t=>{t.dragging&&(n(this,f,!0),t.dom.dataset.dragging="true")},this.dragleaveCallback=(t,e)=>{let l=e.clientX,a=e.clientY;(l<0||a<0||l>window.innerWidth||a>window.innerHeight)&&(n(this,g,null),i(this,C).call(this,t))},this.dropCallback=t=>(i(this,C).call(this,t),!1),this.dragendCallback=t=>{i(this,C).call(this,t)},n(this,C,t=>{n(this,f,!1),t.dom.dataset.dragging="false"})}};F=new WeakMap,I=new WeakMap,b=new WeakMap,g=new WeakMap,D=new WeakMap,f=new WeakMap,v=new WeakSet,vt=function(){var s;return(s=i(this,F))==null?void 0:s.get(H.key).filterNodes},P=function(){var s;return(s=i(this,F))==null?void 0:s.get(K)},w=new WeakMap,y=new WeakMap,Y=new WeakMap,L=new WeakMap,O=new WeakMap,$=new WeakMap,_=new WeakMap,C=new WeakMap;var tt=q(new G,"blockService");U(H,{displayName:"Ctx<blockService>"});var et=q({},"blockSpec");U(H,{displayName:"Ctx<blockSpec>"});var it=rt(s=>{let t=new lt("MILKDOWN_BLOCK"),e=s.get(tt.key),l=s.get(et.key);return new nt(V(T({key:t},l),{props:V(T({},l.props),{handleDOMEvents:{drop:a=>e.dropCallback(a),pointermove:(a,o)=>e.mousemoveCallback(a,o),keydown:a=>e.keydownCallback(a),dragover:(a,o)=>e.dragoverCallback(a,o),dragleave:(a,o)=>e.dragleaveCallback(a,o),dragenter:a=>e.dragenterCallback(a),dragend:a=>e.dragendCallback(a)}})}))});U(it,{displayName:"Prose<block>"});var u,k,M,W,N,j,J,A,R,z,Q,bt,gt=class{constructor(t){r(this,Q),r(this,u),r(this,k),r(this,M),r(this,W),r(this,N),r(this,j),r(this,J),r(this,A),r(this,R),r(this,z),n(this,W,null),n(this,N,!1),this.update=()=>{requestAnimationFrame(()=>{if(!i(this,N))try{Mt(this,Q,bt).call(this),n(this,N,!0)}catch{}})},this.destroy=()=>{var e,l;(e=i(this,M))==null||e.unBind(),(l=i(this,M))==null||l.removeEvent(i(this,u)),i(this,u).remove()},this.show=e=>{let l=e.el,a=i(this,k).get(K).dom,o={ctx:i(this,k),active:e,editorDom:a,blockDom:i(this,u)},c={contextElement:l,getBoundingClientRect:()=>i(this,R)?i(this,R).call(this,o):l.getBoundingClientRect()},d=[ct()];if(i(this,A)){let h=i(this,A).call(this,o),p=ht(h);d.push(p)}dt(c,i(this,u),T({placement:i(this,z)?i(this,z).call(this,o):"left",middleware:[...d,...i(this,j)]},i(this,J))).then(({x:h,y:p})=>{Object.assign(i(this,u).style,{left:`${h}px`,top:`${p}px`}),i(this,u).dataset.show="true"})},this.hide=()=>{i(this,u).dataset.show="false"},n(this,k,t.ctx),n(this,u,t.content),n(this,A,t.getOffset),n(this,R,t.getPosition),n(this,z,t.getPlacement),n(this,j,t.middleware??[]),n(this,J,t.floatingUIOptions??{}),this.hide()}get active(){return i(this,W)}};u=new WeakMap,k=new WeakMap,M=new WeakMap,W=new WeakMap,N=new WeakMap,j=new WeakMap,J=new WeakMap,A=new WeakMap,R=new WeakMap,z=new WeakMap,Q=new WeakSet,bt=function(){var s;(s=i(this,k).get(K).dom.parentElement)==null||s.appendChild(i(this,u));let t=i(this,k).get(tt.key);t.bind(i(this,k),e=>{e.type==="hide"?(this.hide(),n(this,W,null)):e.type==="show"&&(this.show(e.active),n(this,W,e.active))}),n(this,M,t),i(this,M).addEvent(i(this,u)),i(this,u).draggable=!0};var wt=[et,H,tt,it];wt.key=et.key;wt.pluginKey=it.key;export{H as a,gt as b,wt as c};
